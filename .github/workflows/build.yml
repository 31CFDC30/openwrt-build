name: Build helloworld feed packages only

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OPENWRT_VERSION: v24.10.1
      FEED_HELLOWORLD: https://github.com/fw876/helloworld.git

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 unzip wget zlib1g-dev

    - name: Clone OpenWrt source
      run: |
        git clone --depth=1 --branch $OPENWRT_VERSION https://github.com/openwrt/openwrt.git openwrt

    - name: Add helloworld feed
      run: |
        cd openwrt
        sed -i "/helloworld/d" feeds.conf.default
        echo "src-git helloworld $FEED_HELLOWORLD" >> feeds.conf.default

    - name: Update and install helloworld feed
      run: |
        cd openwrt
        ./scripts/feeds update helloworld
        ./scripts/feeds install -a -f -p helloworld

    - name: Configure minimal build (no firmware)
      run: |
        cd openwrt
        make defconfig

    - name: Build only helloworld packages
      run: |
        cd openwrt
        make package/helloworld/compile -j$(nproc) V=s

    - name: Upload compiled helloworld packages
      uses: actions/upload-artifact@v4
      with:
        name: helloworld-ipks
        path: openwrt/bin/packages/
